// 1. æ•°æ®æºé…ç½®
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ==========================================
// ğŸ” è®¤è¯æ¨¡å— (Auth / User System)
// éµå¾ª NextAuth.js (Auth.js) é€‚é…å™¨æ ‡å‡†
// ==========================================

// ==========================================
// ğŸ” è®¤è¯æ¨¡å— (Auth / User System)
// é€‚é… Better-Auth
// ==========================================

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions      Session[]
  accounts      Account[]
  
  // ä¸šåŠ¡å…³è”
  items         Item[]
  categories    Category[]
  tags          Tag[]
  usageLogs     UsageLog[]

  // Better-Auth Plugins
  twoFactorEnabled Boolean? @default(false)
  twoFactors       TwoFactor[]
  passkeys         Passkey[]
}

model TwoFactor {
  id          String  @id @default(cuid())
  secret      String
  backupCodes String
  userId      String
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Passkey {
  id           String    @id @default(cuid())
  name         String?
  publicKey    String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialID String
  counter      Int
  deviceType   String
  backedUp     Boolean
  transports   String?
  createdAt    DateTime? @default(now())
  aaguid       String?
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Verification {
  id         String    @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt
}

// ==========================================
// ğŸ“¦ æ ¸å¿ƒä¸šåŠ¡æ¨¡å— (Inventory System)
// ==========================================

model Category {
  id        String   @id @default(cuid())
  name      String
  icon      String?  // å­˜å‚¨ Lucide å›¾æ ‡åç§°ï¼Œå¦‚ "toothbrush"
  color     String?  // å­˜å‚¨é¢œè‰²ä»£ç ï¼Œå¦‚ "#FF0000"
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  items     Item[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, name]) // åŒä¸€ä¸ªç”¨æˆ·ä¸‹åˆ†ç±»åä¸é‡å¤
}

model Tag {
  id        String   @id @default(cuid())
  name      String
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  items     Item[]   // éšå¼å¤šå¯¹å¤šå…³ç³»

  createdAt DateTime @default(now())

  @@unique([userId, name]) // åŒä¸€ä¸ªç”¨æˆ·ä¸‹æ ‡ç­¾åä¸é‡å¤
}

model Item {
  id               String   @id @default(cuid())
  
  // 1. åŸºç¡€ä¿¡æ¯
  name             String
  image            String?  // ç‰©å“ Logo/ç…§ç‰‡ URL
  brand            String?  // å“ç‰Œ
  price            Decimal? // ä»·æ ¼ (Prisma ä¼šå¤„ç† SQLite çš„ç²¾åº¦é—®é¢˜)
  note             String?  // å¤‡æ³¨
  
  // 2. çŠ¶æ€ä¸åº“å­˜
  stock            Int      @default(1) // å½“å‰åº“å­˜æ•°é‡
  isArchived       Boolean  @default(false) // å½’æ¡£ï¼ˆé€»è¾‘åˆ é™¤ï¼‰
  isPinned         Boolean  @default(false) // ç½®é¡¶ï¼ˆä¸»é¡µæ˜¾ç¤ºï¼‰
  
  // 3. ç”Ÿå‘½å‘¨æœŸå…³é”®æŒ‡æ ‡
  // ä¸Šæ¬¡æ›´æ¢/å¼€å§‹ä½¿ç”¨æ—¶é—´ (ç”¨äºè®¡ç®—è¿›åº¦)
  lastOpenedAt     DateTime? 
  
  // ç”Ÿå‘½å‘¨æœŸ (å¤©æ•°) - è½¯æ€§å‘¨æœŸï¼Œå¦‚â€œç‰™åˆ·å»ºè®®90å¤©æ›´æ¢â€
  lifespanDays     Int?     
  
  // [NEW] ä¿è´¨æœŸå¤©æ•° (ç¡¬æ€§é™åˆ¶) - ç›¸å¯¹æ—¶é—´ï¼Œå¦‚"ä¿è´¨æœŸ365å¤©"
  shelfLifeDays    Int?
  
  // [NEW] å•ä½ä¸è§„æ ¼
  unit             String    @default("ä¸ª") // è®¡é‡å•ä½ï¼Œå¦‚ "ä¸ª", "ml", "g"
  quantity         Float     @default(1)    // å•ä»¶è§„æ ¼ï¼Œå¦‚ 500 (ml)
  
  // [NEW] å›ºå®šåº“å­˜æ¨¡å¼ (è®¢é˜…åˆ¶ä¸“ç”¨)
  isStockFixed     Boolean   @default(false)
  
  // @deprecated: ç¡¬æ€§è¿‡æœŸæ—¶é—´ - ç»å¯¹æ—¥æœŸï¼Œå¦‚"ç‰›å¥¶ 2025-10-01 è¿‡æœŸ"
  // è¯·ä½¿ç”¨ shelfLifeDays æ›¿ä»£ã€‚ä¿ç•™æ­¤å­—æ®µç”¨äºæ•°æ®è¿ç§»å…¼å®¹ã€‚
  expirationDate   DateTime? 
  
  // æå‰é€šçŸ¥å¤©æ•° (é»˜è®¤ 3 å¤©)
  notifyAdvanceDays Int     @default(3)
  
  // 4. å…³è”å…³ç³»
  categoryId       String
  category         Category @relation(fields: [categoryId], references: [id])
  
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  tags             Tag[]    // å…³è”æ ‡ç­¾è¡¨
  logs             UsageLog[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId])
  @@index([categoryId])
}

// ==========================================
// ğŸ“Š è¿½è¸ªæ¨¡å— (Tracking) - æ›´æ¢å†å²å¿«ç…§
// ==========================================

model UsageLog {
  id              String   @id @default(cuid())

  // -- å¿«ç…§æ•°æ® (æ›´æ¢æ—¶æ•è·çš„ç‰©å“çŠ¶æ€) --
  // æ˜¾å¼å¤åˆ¶è¿™äº›å­—æ®µä»¥ä¿ç•™å†å²è®°å½•ï¼Œ
  // å³ä½¿åŸå§‹ç‰©å“ä¿¡æ¯ç¨åè¢«ä¿®æ”¹ä¹Ÿä¸å—å½±å“ã€‚
  itemName        String
  itemBrand       String?
  itemPrice       Decimal?
  itemNote        String?
  itemUnit        String   // è®¡é‡å•ä½ï¼Œå¦‚ "ä¸ª", "ml"
  itemQuantity    Float    // å•ä»¶è§„æ ¼ï¼Œå¦‚ 500 (ml)

  // -- æ“ä½œå…ƒæ•°æ® --
  replacedAt      DateTime @default(now()) // æ›´æ¢å‘ç”Ÿæ—¶é—´

  // -- å…³è”å…³ç³» --
  itemId          String
  item            Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // -- ç´¢å¼• --
  @@index([itemId])
  @@index([userId])
  @@index([replacedAt])
}
